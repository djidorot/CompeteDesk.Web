@using System
@model CompeteDesk.ViewModels.Habits.HabitsIndexViewModel

@{
    ViewData["Title"] = "Habits";
}

@section Styles {
    <link rel="stylesheet" href="~/css/habits.css" asp-append-version="true" />
}

<div class="cd-page habits-page">
    <div class="cd-page__header habits-header">
        <div>
            <h1 class="cd-h1 mb-1">Habits</h1>
            <p class="cd-muted mb-0">Daily and weekly routines tied to your Workspace & Strategy.</p>
        </div>
        <div class="habits-header__actions">
            <button type="button"
                    class="btn btn-outline-secondary cd-btn"
                    data-habits-ai-open
                    @(Model.IsAiConfigured ? "" : "disabled")>
                ✨ AI Suggest Habits
            </button>
            <a class="btn btn-primary cd-btn" asp-controller="Habits" asp-action="Create"
               asp-route-workspaceId="@(Model.WorkspaceId)"
               asp-route-strategyId="@(Model.StrategyId)"
               asp-route-frequency="@(Model.Frequency)">
                + New Habit
            </a>
        </div>
    </div>

    @if (!Model.IsAiConfigured)
    {
        <div class="cd-card mt-3">
            <div class="cd-card__body">
                <div class="cd-muted">
                    AI is not configured. Add your OpenAI settings (OpenAI:ApiKey, OpenAI:Model) in <code>appsettings.Development.json</code> or user secrets.
                </div>
            </div>
        </div>
    }

    <div class="cd-card mt-4">
        <div class="cd-card__body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-lg-4">
                    <label class="cd-label" for="q">Search</label>
                    <input id="q" name="q" class="form-control cd-input" value="@Model.Query" placeholder="Title or description…" />
                </div>

                <div class="col-lg-3">
                    <label class="cd-label" for="workspaceId">Workspace</label>
                    <select id="workspaceId" name="workspaceId" class="form-select cd-input">
                        <option value="">All workspaces</option>
                        @foreach (var ws in Model.Workspaces)
                        {
                            <option value="@ws.Id" selected="@(Model.WorkspaceId == ws.Id)">@ws.Name</option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="cd-label" for="strategyId">Strategy</label>
                    <select id="strategyId" name="strategyId" class="form-select cd-input">
                        <option value="">All strategies</option>
                        @foreach (var st in Model.Strategies)
                        {
                            <option value="@st.Id" selected="@(Model.StrategyId == st.Id)">@st.Name</option>
                        }
                    </select>
                </div>

                <div class="col-lg-2">
                    <label class="cd-label" for="frequency">Frequency</label>
                    <select id="frequency" name="frequency" class="form-select cd-input">
                        <option value="">All</option>
                        <option value="Daily" selected="@(Model.Frequency == "Daily")">Daily</option>
                        <option value="Weekly" selected="@(Model.Frequency == "Weekly")">Weekly</option>
                    </select>
                </div>

                <div class="col-12 d-flex gap-2">
                    <button class="btn btn-outline-secondary cd-btn" type="submit">Filter</button>
                    <a class="btn btn-link cd-link" asp-controller="Habits" asp-action="Index">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <div class="habits-grid mt-4">
        @if (Model.Habits.Count == 0)
        {
            <div class="cd-card">
                <div class="cd-card__body">
                    <div class="cd-muted">No habits yet. Create your first habit to start building momentum.</div>
                </div>
            </div>
        }
        else
        {
            @foreach (var h in Model.Habits)
            {
                var pct = h.TargetCount <= 0 ? 0 : (int)Math.Round((double)Math.Min(h.PeriodCount, h.TargetCount) / h.TargetCount * 100.0);
                <div class="cd-card habit-card @(h.IsActive ? "" : "habit-card--inactive")">
                    <div class="cd-card__body">
                        <div class="habit-card__top">
                            <div class="habit-card__titlewrap">
                                <div class="habit-pill">@h.Frequency</div>
                                <h2 class="cd-h2 habit-title">@h.Title</h2>
                                <div class="habit-meta">
                                    <span class="habit-meta__item">Workspace: <strong>@h.WorkspaceName</strong></span>
                                    @if (!string.IsNullOrWhiteSpace(h.StrategyName))
                                    {
                                        <span class="habit-meta__sep">•</span>
                                        <span class="habit-meta__item">Strategy: <strong>@h.StrategyName</strong></span>
                                    }
                                </div>
                            </div>
                            <div class="habit-card__menu">
                                <a class="btn btn-sm btn-outline-secondary cd-btn" asp-action="Edit" asp-route-id="@h.Id">Edit</a>
                                <a class="btn btn-sm btn-outline-secondary cd-btn" asp-action="Details" asp-route-id="@h.Id">Details</a>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(h.Description))
                        {
                            <p class="cd-muted habit-desc">@h.Description</p>
                        }

                        <div class="habit-progress">
                            <div class="habit-progress__row">
                                <div class="habit-progress__label">
                                    <strong>@h.PeriodCount</strong> / @h.TargetCount
                                    <span class="cd-muted">(@h.PeriodStartUtc.ToString("MMM d")–@h.PeriodEndUtc.ToString("MMM d"))</span>
                                </div>
                                <div class="habit-progress__pct">@pct%</div>
                            </div>
                            <div class="habit-progress__bar" role="progressbar" aria-valuenow="@pct" aria-valuemin="0" aria-valuemax="100">
                                <div class="habit-progress__barfill" style="width:@pct%"></div>
                            </div>
                        </div>

                        <div class="habit-card__actions">
                            <form method="post" asp-action="Checkin" asp-route-id="@h.Id">
                                @Html.AntiForgeryToken()
                                <button class="btn btn-primary cd-btn" type="submit" @(h.IsActive ? "" : "disabled")>
                                    ✅ Check in today
                                </button>
                            </form>

                            <form method="post" asp-action="ToggleActive" asp-route-id="@h.Id">
                                @Html.AntiForgeryToken()
                                <button class="btn btn-outline-secondary cd-btn" type="submit">
                                    @(h.IsActive ? "Pause" : "Resume")
                                </button>
                            </form>

                            <a class="btn btn-outline-danger cd-btn" asp-action="Delete" asp-route-id="@h.Id">Delete</a>
                        </div>

                        @if (!h.IsActive)
                        {
                            <div class="habit-inactive-note">Paused</div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- AI Modal -->
<div class="modal fade" id="habitsAiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Habit Suggestions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <form data-habits-ai-form>
                    @Html.AntiForgeryToken()

                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="cd-label" for="aiWorkspace">Workspace</label>
                            <select id="aiWorkspace" class="form-select cd-input" name="workspaceId" required>
                                <option value="">Select workspace…</option>
                                @foreach (var ws in Model.Workspaces)
                                {
                                    <option value="@ws.Id" selected="@(Model.WorkspaceId == ws.Id)">@ws.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="cd-label" for="aiStrategy">Strategy (optional)</label>
                            <select id="aiStrategy" class="form-select cd-input" name="strategyId">
                                <option value="">None</option>
                                @foreach (var st in Model.Strategies)
                                {
                                    <option value="@st.Id" selected="@(Model.StrategyId == st.Id)">@st.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <label class="cd-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary cd-btn" data-habits-ai-generate>
                                Generate
                            </button>
                        </div>

                        <div class="col-12">
                            <label class="cd-label" for="aiGoal">Goal (optional)</label>
                            <input id="aiGoal" name="goal" class="form-control cd-input" placeholder="e.g., Improve lead generation, launch campaign, increase retention…" />
                        </div>
                    </div>
                </form>

                <div class="habits-ai-status mt-3" data-habits-ai-status></div>

                <div class="habits-ai-results mt-3" data-habits-ai-results hidden>
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="cd-muted">Select suggestions to create habits:</div>
                        <button type="button" class="btn btn-success cd-btn" data-habits-ai-create disabled>
                            Create selected
                        </button>
                    </div>

                    <div class="habits-ai-list" data-habits-ai-list></div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/habits-ai.js" asp-append-version="true"></script>
}
