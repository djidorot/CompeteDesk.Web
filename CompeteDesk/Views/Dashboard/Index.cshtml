@model CompeteDesk.ViewModels.Dashboard.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    // Tell _Layout to use container-fluid
    ViewData["LayoutFluid"] = true;
    ViewData["UseSidebar"] = true;
}

<link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/dashboard-business-analysis.css" asp-append-version="true" />

<div class="cd-dashboard">

    <!-- Command Header -->
    <div class="cd-command card shadow-sm">
        <div class="card-body">
            <div class="cd-command-top">
                <div class="cd-command-left">
                    <div class="cd-workspace">
                        <span class="cd-badge">Workspace</span>
                        <h1 class="cd-title mb-0">@Model.WorkspaceName</h1>
                        <div class="cd-sub">Welcome back, <strong>@Model.UserDisplayName</strong>. Focus for the week: <span class="cd-focus">‚Äú@Model.WeeklyFocus‚Äù</span></div>
                    </div>

                    <div class="cd-meta">
                        <div class="cd-meta-item">
                            <div class="cd-meta-label">Strategy Mode</div>
                            <div class="cd-meta-value">@Model.StrategyMode</div>
                        </div>
                        <div class="cd-meta-item">
                            <div class="cd-meta-label">Active Strategies</div>
                            <div class="cd-meta-value">@Model.ActiveStrategiesCount</div>
                        </div>
                    </div>
                </div>

                <div class="cd-command-right">
                    <div class="cd-score">
                        <div class="cd-score-label">Strategy Score</div>
                        <div class="cd-score-value">@Model.StrategyScore</div>
                        <div class="cd-score-meter" role="progressbar" aria-valuenow="@Model.StrategyScore" aria-valuemin="0" aria-valuemax="100">
                            <div class="cd-score-bar" style="width:@Model.StrategyScore%"></div>
                        </div>
                    </div>

                    <div class="cd-status">
                        <div class="cd-status-label">Status</div>
                        <div class="cd-status-pill" data-health="@Model.HealthStatus">@Model.HealthStatus</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="cd-grid mt-3">

        <!-- Business Analysis (AI) -->
        <section class="cd-panel card shadow-sm cd-biz" data-cd-biz-root
                 data-workspace-id="@Model.WorkspaceId"
                 data-needs-profile="@Model.NeedsBusinessProfile.ToString().ToLowerInvariant()">
            <div class="card-body">
                <div class="cd-panel-head">
                    <h2 class="cd-h2">Business Analysis (AI)</h2>
                    <div class="cd-panel-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary" data-cd-biz-edit>
                            @(Model.NeedsBusinessProfile ? "Set business profile" : "Edit profile")
                        </button>

                        <form method="post" asp-controller="Dashboard" asp-action="GenerateBusinessAnalysis" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="workspaceId" value="@Model.WorkspaceId" />
                            <button type="submit" class="btn btn-sm btn-primary" data-cd-biz-generate>
                                @(Model.BusinessAnalysis == null ? "Generate" : "Regenerate")
                            </button>
                        </form>
                    </div>
                </div>

                <div class="cd-muted small">
                    Profile: <strong>@(string.IsNullOrWhiteSpace(Model.BusinessType) ? "‚Äî" : Model.BusinessType)</strong>
                    <span class="mx-1">‚Ä¢</span>
                    Country: <strong>@(string.IsNullOrWhiteSpace(Model.Country) ? "‚Äî" : Model.Country)</strong>
                </div>

                @if (Model.BusinessAnalysis == null)
                {
                    <div class="cd-biz-empty mt-3">
                        <div class="cd-muted">No analysis generated yet. Click <strong>Generate</strong> to create SWOT + Porter's Five Forces (and competitors) for this workspace.</div>
                    </div>
                }
                else
                {
                    <div class="cd-biz-grid mt-3">
                        <!-- SWOT -->
                        <div class="cd-biz-card">
                            <div class="cd-biz-title">SWOT</div>
                            <div class="cd-biz-swot">
                                <div>
                                    <div class="cd-biz-h">Strengths</div>
                                    <ul class="cd-biz-ul">
                                        @foreach (var x in Model.BusinessAnalysis.Strengths)
                                        {
                                            <li>@x</li>
                                        }
                                    </ul>
                                </div>
                                <div>
                                    <div class="cd-biz-h">Weaknesses</div>
                                    <ul class="cd-biz-ul">
                                        @foreach (var x in Model.BusinessAnalysis.Weaknesses)
                                        {
                                            <li>@x</li>
                                        }
                                    </ul>
                                </div>
                                <div>
                                    <div class="cd-biz-h">Opportunities</div>
                                    <ul class="cd-biz-ul">
                                        @foreach (var x in Model.BusinessAnalysis.Opportunities)
                                        {
                                            <li>@x</li>
                                        }
                                    </ul>
                                </div>
                                <div>
                                    <div class="cd-biz-h">Threats</div>
                                    <ul class="cd-biz-ul">
                                        @foreach (var x in Model.BusinessAnalysis.Threats)
                                        {
                                            <li>@x</li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Five Forces (business) -->
                        <div class="cd-biz-card">
                            <div class="cd-biz-title">Porter‚Äôs Five Forces (Your Business)</div>
                            <div class="cd-biz-forces">
                                @{
                                    var f = Model.BusinessAnalysis;
                                }

                                <div class="cd-force">
                                    <div class="cd-force-name">Rivalry</div>
                                    <div class="cd-force-score" data-score="@f.Rivalry.Score">@f.Rivalry.Score / 5</div>
                                    <div class="cd-muted small">@f.Rivalry.Notes</div>
                                </div>
                                <div class="cd-force">
                                    <div class="cd-force-name">Threat of New Entrants</div>
                                    <div class="cd-force-score" data-score="@f.NewEntrants.Score">@f.NewEntrants.Score / 5</div>
                                    <div class="cd-muted small">@f.NewEntrants.Notes</div>
                                </div>
                                <div class="cd-force">
                                    <div class="cd-force-name">Threat of Substitutes</div>
                                    <div class="cd-force-score" data-score="@f.Substitutes.Score">@f.Substitutes.Score / 5</div>
                                    <div class="cd-muted small">@f.Substitutes.Notes</div>
                                </div>
                                <div class="cd-force">
                                    <div class="cd-force-name">Supplier Power</div>
                                    <div class="cd-force-score" data-score="@f.SupplierPower.Score">@f.SupplierPower.Score / 5</div>
                                    <div class="cd-muted small">@f.SupplierPower.Notes</div>
                                </div>
                                <div class="cd-force">
                                    <div class="cd-force-name">Buyer Power</div>
                                    <div class="cd-force-score" data-score="@f.BuyerPower.Score">@f.BuyerPower.Score / 5</div>
                                    <div class="cd-muted small">@f.BuyerPower.Notes</div>
                                </div>
                            </div>
                        </div>

                        <!-- Competitors -->
                        <div class="cd-biz-card">
                            <div class="cd-biz-title">Key Competitors (Auto-identified)</div>
                            <div class="cd-biz-competitors">
                                @foreach (var c in Model.BusinessAnalysis.Competitors)
                                {
                                    <span class="cd-comp-chip" title="@c.WhyRelevant">@c.Name</span>
                                }
                            </div>

                            <div class="cd-biz-title mt-3">Competitor Five Forces Summary</div>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle cd-biz-table">
                                    <thead>
                                        <tr>
                                            <th>Competitor</th>
                                            <th class="text-nowrap">Rivalry</th>
                                            <th class="text-nowrap">New Entrants</th>
                                            <th class="text-nowrap">Substitutes</th>
                                            <th class="text-nowrap">Supplier</th>
                                            <th class="text-nowrap">Buyer</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var c in Model.BusinessAnalysis.Competitors)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="fw-semibold">@c.Name</div>
                                                    @if (!string.IsNullOrWhiteSpace(c.WhyRelevant))
                                                    {
                                                        <div class="cd-muted small">@c.WhyRelevant</div>
                                                    }
                                                </td>
                                                <td><span class="cd-score-pill" data-score="@c.Rivalry.Score">@c.Rivalry.Score</span></td>
                                                <td><span class="cd-score-pill" data-score="@c.NewEntrants.Score">@c.NewEntrants.Score</span></td>
                                                <td><span class="cd-score-pill" data-score="@c.Substitutes.Score">@c.Substitutes.Score</span></td>
                                                <td><span class="cd-score-pill" data-score="@c.SupplierPower.Score">@c.SupplierPower.Score</span></td>
                                                <td><span class="cd-score-pill" data-score="@c.BuyerPower.Score">@c.BuyerPower.Score</span></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </section>
        <!-- Today -->
        <section class="cd-panel card shadow-sm">
            <div class="card-body">
                <div class="cd-panel-head">
                    <h2 class="cd-h2">Today‚Äôs Critical Actions</h2>
                    <div class="cd-panel-actions">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-cd-filter="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-cd-filter="high">High Impact</button>
                    </div>
                </div>

                <div class="cd-actions" id="cdTodayActions">
                    @for (var i = 0; i < Model.TodayActions.Count; i++)
                    {
                        var item = Model.TodayActions[i];
                        <div class="cd-action-item" data-impact="@item.Impact.ToLowerInvariant()">
                            <label class="cd-action-check">
                                <input type="checkbox" class="form-check-input" data-cd-action-check />
                                <span class="cd-action-title">@item.Title</span>
                            </label>
                            <div class="cd-action-meta">
                                <span class="cd-chip">@item.Principle</span>
                                <span class="cd-chip cd-chip-impact">@item.Impact Impact</span>
                                <span class="cd-chip">@item.Minutes min</span>
                            </div>
                            <div class="cd-action-cta">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-cd-reschedule>Reschedule</button>
                                <button type="button" class="btn btn-sm btn-primary" data-cd-done>Mark Done</button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>

        <!-- Habits -->
        <section class="cd-panel card shadow-sm">
            <div class="card-body">
                <div class="cd-panel-head">
                    <h2 class="cd-h2">Habit Systems</h2>
                    <div class="cd-panel-sub">Strategy Playbook view: cue ‚Üí environment ‚Üí reduce friction.</div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle cd-table">
                        <thead>
                            <tr>
                                <th>Habit</th>
                                <th class="text-nowrap">Streak</th>
                                <th>Status</th>
                                <th class="d-none d-lg-table-cell">Cue</th>
                                <th class="d-none d-lg-table-cell">Environment</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var h in Model.Habits)
                            {
                                <tr>
                                    <td>
                                        <div class="cd-habit-name">@h.Name</div>
                                        <div class="cd-muted small">@h.Notes</div>
                                    </td>
                                    <td class="text-nowrap"><span class="cd-streak">üî• @h.StreakDays</span></td>
                                    <td><span class="cd-pill" data-status="@h.Status">@h.Status</span></td>
                                    <td class="d-none d-lg-table-cell"><span class="cd-muted">@h.Cue</span></td>
                                    <td class="d-none d-lg-table-cell"><span class="cd-muted">@h.Environment</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Strategies -->
        <section class="cd-panel card shadow-sm">
            <div class="card-body">
                <div class="cd-panel-head">
                    <h2 class="cd-h2">Active Strategies</h2>
                    <div class="cd-panel-actions">
                        <a class="btn btn-sm btn-outline-primary disabled" href="#" aria-disabled="true" title="Wireframe-only for now">+ Add Strategy</a>
                    </div>
                </div>

                <div class="cd-strategy-grid">
                    @foreach (var s in Model.ActiveStrategies)
                    {
                        <div class="cd-strategy card">
                            <div class="card-body">
                                <div class="cd-strategy-title">@s.Name</div>
                                <div class="cd-muted">@s.SourceBook ‚Ä¢ @s.CorePrinciple</div>

                                <div class="cd-strategy-metrics mt-2">
                                    <div class="cd-mini">
                                        <div class="cd-mini-label">Execution</div>
                                        <div class="cd-mini-value">@s.ExecutionRate%</div>
                                        <div class="cd-mini-meter">
                                            <div class="cd-mini-bar" style="width:@s.ExecutionRate%"></div>
                                        </div>
                                    </div>

                                    <div class="cd-mini">
                                        <div class="cd-mini-label">Effectiveness</div>
                                        <div class="cd-pill" data-effect="@s.Effectiveness">@s.Effectiveness</div>
                                    </div>
                                </div>

                                <div class="cd-strategy-actions mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary">View</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary">Adjust</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary">Pause</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>

        <!-- Metrics -->
        <section class="cd-panel card shadow-sm">
            <div class="card-body">
                <div class="cd-panel-head">
                    <h2 class="cd-h2">Metrics & Momentum</h2>
                    <div class="cd-panel-sub">Keep a few KPIs visible. Compounding needs feedback.</div>
                </div>

                <div class="cd-kpi-grid">
                    @foreach (var k in Model.KeyMetrics)
                    {
                        <div class="cd-kpi card">
                            <div class="card-body">
                                <div class="cd-kpi-name">@k.Name</div>
                                <div class="cd-kpi-value">@k.Value</div>
                                <div class="cd-kpi-trend" data-trend="@k.TrendDirection">
                                    <span class="cd-kpi-trend-val">@k.Trend</span>
                                    <span class="cd-muted">‚Ä¢ @k.Subtext</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="cd-momentum mt-3">
                    <div class="cd-momentum-label">Momentum</div>
                    <div class="cd-momentum-bar" aria-hidden="true">
                        <div class="cd-momentum-fill"></div>
                    </div>
                    <div class="cd-muted small mt-1">Hint: momentum rises when execution is consistent and KPIs move together.</div>
                </div>
            </div>
        </section>

        <!-- Weekly Review -->
        <section class="cd-panel card shadow-sm">
            <div class="card-body">
                <div class="cd-panel-head">
                    <h2 class="cd-h2">Weekly Review</h2>
                    <div class="cd-panel-sub">Fast feedback loop: keep ‚Üí fix ‚Üí drop.</div>
                </div>

                <div class="cd-review">
                    <div class="cd-review-item">
                        <div class="cd-review-label">What worked</div>
                        <div class="cd-review-text">@Model.WeeklyReviewHighlight</div>
                    </div>
                    <div class="cd-review-item">
                        <div class="cd-review-label">What failed</div>
                        <div class="cd-review-text">@Model.WeeklyReviewFailure</div>
                    </div>
                    <div class="cd-review-item">
                        <div class="cd-review-label">Adjustment</div>
                        <div class="cd-review-text">@Model.WeeklyReviewAdjustment</div>
                    </div>

                    <div class="cd-review-cta mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" disabled title="Coming soon">Open Review Form</button>
                        <button type="button" class="btn btn-primary btn-sm" disabled title="Coming soon">Save Changes</button>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Business Profile Modal -->
<div class="modal fade" id="cdBizModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set your business profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    This is required to generate your SWOT Analysis and Porter‚Äôs Five Forces (including key competitors for your location).
                </p>

                <form id="cdBizProfileForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="workspaceId" value="@Model.WorkspaceId" />

                    <div class="mb-3">
                        <label class="form-label">Type of business</label>
                        <input class="form-control" name="businessType" value="@Model.BusinessType" placeholder="e.g., Online Coding School, Coffee Shop, SaaS" required />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Location / Country</label>
                        <input class="form-control" name="country" value="@Model.Country" placeholder="e.g., Philippines" required />
                    </div>

                    <div class="cd-biz-modal-error text-danger small d-none" data-cd-biz-error></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-cd-biz-save>Save</button>
                <button type="button" class="btn btn-primary d-none" disabled data-cd-biz-saving>
                    <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                    Saving‚Ä¶
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dashboard-business-analysis.js" asp-append-version="true"></script>
}
