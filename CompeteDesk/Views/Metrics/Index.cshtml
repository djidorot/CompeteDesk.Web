@model CompeteDesk.ViewModels.Metrics.MetricsViewModel
@{
    ViewData["Title"] = "Metrics";
    string tab = (Model.SelectedTab ?? "overview").ToLowerInvariant();
    string range = (Model.SelectedRange ?? "day").ToLowerInvariant();

    string TabClass(string key) => tab == key ? "cd-mtabs__tab is-active" : "cd-mtabs__tab";
    string UrlForTab(string key) => Url.Action("Index", "Metrics", new { tab = key, range = range, from = Model.FromDate, to = Model.ToDate }) ?? "#";
    string UrlForRange(string key) => Url.Action("Index", "Metrics", new { tab = tab, range = key }) ?? "#";

    string Sign(double v) => v > 0 ? "+" : "";
    string DeltaClass(double v) => v > 0 ? "is-up" : (v < 0 ? "is-down" : "is-flat");
    string FormatPct(double v) => $"{Sign(v)}{v:0.#}%";

    var infoText = tab == "momentum" ? Model.KeyMetricsInfoText : Model.InfoText;
}

<link rel="stylesheet" href="~/css/metrics.css" asp-append-version="true" />

<div class="cd-metrics">
    <div class="cd-mhdr">
        <h1 class="cd-mhdr__title">Metrics</h1>

        <div class="cd-mhdr__controls">
            <div class="cd-mselect" data-m-range>
                <button type="button" class="cd-mselect__btn" aria-haspopup="listbox" aria-expanded="false">
                    <span class="cd-mselect__label">
                        @(range == "custom" ? "Custom" :
                          range == "week" ? "Last 7 days" :
                          range == "month" ? "Last 30 days" : "Last day")
                    </span>
                    <span class="cd-mselect__chev" aria-hidden="true">â–¾</span>
                </button>
                <div class="cd-mselect__menu" role="listbox">
                    <a class="cd-mselect__item" href="@UrlForRange("day")">Last day</a>
                    <a class="cd-mselect__item" href="@UrlForRange("week")">Last 7 days</a>
                    <a class="cd-mselect__item" href="@UrlForRange("month")">Last 30 days</a>
                    <button class="cd-mselect__item cd-mselect__item--btn" type="button" data-open-custom>Customâ€¦</button>
                </div>
            </div>

            <button class="cd-mdate" type="button" data-m-date>
                <span class="cd-mdate__ico" aria-hidden="true">ðŸ“…</span>
                <span class="cd-mdate__text">@Model.FromDate â€“ @Model.ToDate</span>
            </button>

            @if (tab == "momentum")
            {
                <button class="cd-btn" type="button" data-open-km-config>Configure</button>
            }

            <div class="cd-minfo" title="@infoText">
                <span aria-hidden="true">â“˜</span>
                <span class="cd-minfo__txt">Info</span>
            </div>
        </div>
    </div>

    <nav class="cd-mtabs" aria-label="Metrics tabs">
        <a class="@TabClass("momentum")" href="@UrlForTab("momentum")">Momentum</a>
        <a class="@TabClass("overview")" href="@UrlForTab("overview")">Overview</a>
        <a class="@TabClass("workspaces")" href="@UrlForTab("workspaces")">Workspaces</a>
        <a class="@TabClass("strategies")" href="@UrlForTab("strategies")">Strategies</a>
        <a class="@TabClass("actions")" href="@UrlForTab("actions")">Actions</a>
        <a class="@TabClass("warroom")" href="@UrlForTab("warroom")">War Room</a>
        <a class="@TabClass("ai")" href="@UrlForTab("ai")">AI History</a>
    </nav>

    @if (tab == "momentum")
    {
        <section class="cd-kmetrics">
            <div class="cd-kmetrics__grid">
                @if (Model.KeyMetrics.Count == 0)
                {
                    <div class="cd-muted">No enabled key metrics yet. Click <strong>Configure</strong> to enable metrics.</div>
                }
                else
                {
                    foreach (var m in Model.KeyMetrics)
                    {
                        <div class="cd-kmcard cd-kmcard--@m.Signal">
                            <div class="cd-kmcard__top">
                                <div class="cd-kmcard__name">@m.DisplayName</div>
                                <div class="cd-kmcard__delta @DeltaClass(m.DeltaPct)">
                                    <span class="cd-kmcard__arrow" aria-hidden="true">@(m.DeltaPct >= 0 ? "â†‘" : "â†“")</span>
                                    <span>@FormatPct(m.DeltaPct)</span>
                                </div>
                            </div>

                            <div class="cd-kmcard__value">@m.ValueText</div>

                            <div class="cd-kmcard__chart">
                                @await Html.PartialAsync("_MetricsChartDecimal", new { Points = m.Points, Labels = m.Labels, Percent = m.Percent })
                            </div>

                            <form class="cd-kmcard__form" method="post" asp-action="AddKeyMetricEntry" asp-controller="Metrics">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="definitionId" value="@m.DefinitionId" />
                                <input type="hidden" name="range" value="@range" />
                                <input type="hidden" name="from" value="@Model.FromDate" />
                                <input type="hidden" name="to" value="@Model.ToDate" />

                                <input class="cd-field__input cd-kmcard__date" type="date" name="date" value="@Model.ToDate" />
                                <input class="cd-field__input cd-kmcard__val" type="number" step="any" name="value" placeholder="Value" />
                                <button class="cd-btnprimary" type="submit">Save</button>
                            </form>
                        </div>
                    }
                }
            </div>
        </section>

        <div class="cd-modal" data-km-config-modal hidden>
            <div class="cd-modal__backdrop" data-close></div>
            <div class="cd-modal__card" role="dialog" aria-modal="true" aria-label="Configure key metrics">
                <div class="cd-modal__hdr">
                    <div class="cd-modal__title">Configure key metrics</div>
                    <button class="cd-iconbtn" type="button" data-close aria-label="Close">âœ•</button>
                </div>

                <form class="cd-modal__body" method="post" asp-controller="Metrics" asp-action="SaveKeyMetricsConfig">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="range" value="@range" />
                    <input type="hidden" name="from" value="@Model.FromDate" />
                    <input type="hidden" name="to" value="@Model.ToDate" />

                    <div class="cd-tablewrap">
                        <table class="cd-table cd-table--compact">
                            <thead>
                                <tr>
                                    <th>On</th>
                                    <th>Metric</th>
                                    <th>Unit</th>
                                    <th class="cd-ta-r">Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in Model.KeyMetricConfig)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="enabledIds" value="@row.Id" @(row.IsEnabled ? "checked" : null) />
                                        </td>
                                        <td>
                                            <input class="cd-field__input" type="text" name="name_@row.Id" value="@row.DisplayName" />
                                            <div class="cd-muted" style="font-size:12px">@row.Key</div>
                                        </td>
                                        <td>@row.Unit</td>
                                        <td class="cd-ta-r" style="width:110px">
                                            <input class="cd-field__input" type="number" name="order_@row.Id" value="@row.SortOrder" />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="cd-modal__actions">
                        <button class="cd-btnlite" type="button" data-close>Cancel</button>
                        <button class="cd-btnprimary" type="submit">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <section class="cd-kpis">
            @foreach (var kpi in Model.Kpis)
            {
                <div class="cd-kpi">
                    <div class="cd-kpi__top">
                        <div class="cd-kpi__ico" aria-hidden="true">@kpi.Icon</div>
                        <button class="cd-kpi__more" type="button" aria-label="More">â€¦</button>
                    </div>
                    <div class="cd-kpi__label">@kpi.Label</div>
                    <div class="cd-kpi__value">@kpi.ValueText</div>
                    <div class="cd-kpi__delta @DeltaClass(kpi.DeltaPct)">
                        <span class="cd-kpi__arrow" aria-hidden="true">@(kpi.DeltaPct >= 0 ? "â†—" : "â†˜")</span>
                        <span>@FormatPct(kpi.DeltaPct)</span>
                        <span class="cd-kpi__muted">vs. prior period (new items)</span>
                    </div>
                </div>
            }
        </section>

        <section class="cd-mgrid">
            <div class="cd-panel">
                <div class="cd-panel__hdr">
                    <div class="cd-panel__title">@Model.LeftChartTitle <span class="cd-i" title="Based on items created in this period.">i</span></div>
                    <div class="cd-panel__actions">
                        <button class="cd-iconbtn" type="button" title="Refresh">âŸ³</button>
                        <button class="cd-iconbtn" type="button" title="Download">â‡©</button>
                        <button class="cd-iconbtn" type="button" title="Open">â†—</button>
                    </div>
                </div>
                <div class="cd-panel__body">
                    @await Html.PartialAsync("_MetricsChart", new { Points = Model.LeftChartPoints, Labels = Model.LeftChartLabels, Percent = Model.LeftChartPercent })
                </div>
            </div>

            <div class="cd-panel">
                <div class="cd-panel__hdr">
                    <div class="cd-panel__title">@Model.RightChartTitle <span class="cd-i" title="Based on items created in this period.">i</span></div>
                    <div class="cd-panel__actions">
                        <button class="cd-iconbtn" type="button" title="Refresh">âŸ³</button>
                        <button class="cd-iconbtn" type="button" title="Download">â‡©</button>
                        <button class="cd-iconbtn" type="button" title="Open">â†—</button>
                    </div>
                </div>
                <div class="cd-panel__body">
                    @await Html.PartialAsync("_MetricsChart", new { Points = Model.RightChartPoints, Labels = Model.RightChartLabels, Percent = Model.RightChartPercent })
                </div>
            </div>

            <div class="cd-panel">
                <div class="cd-panel__hdr">
                    <div class="cd-panel__title">@Model.LeftTableTitle</div>
                    <div class="cd-panel__actions">
                        <button class="cd-iconbtn" type="button" title="Refresh">âŸ³</button>
                        <button class="cd-iconbtn" type="button" title="Filter">âŸ‚</button>
                        <button class="cd-iconbtn" type="button" title="Download">â‡©</button>
                        <button class="cd-btn" type="button">Explore more</button>
                    </div>
                </div>
                <div class="cd-panel__body">
                    <div class="cd-tablewrap">
                        <table class="cd-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="cd-ta-r">Total</th>
                                    <th class="cd-ta-r">Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.LeftTableRows.Count == 0)
                                {
                                    <tr><td colspan="3" class="cd-muted">No data in this period.</td></tr>
                                }
                                else
                                {
                                    foreach (var row in Model.LeftTableRows)
                                    {
                                        <tr>
                                            <td>@row.Name</td>
                                            <td class="cd-ta-r">@row.ValueText</td>
                                            <td class="cd-ta-r">
                                                <span class="cd-chip @DeltaClass(row.ChangePct)">
                                                    <span class="cd-chip__txt">@FormatPct(row.ChangePct)</span>
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="cd-panel">
                <div class="cd-panel__hdr">
                    <div class="cd-panel__title">@Model.RightTableTitle</div>
                    <div class="cd-panel__actions">
                        <button class="cd-iconbtn" type="button" title="Refresh">âŸ³</button>
                        <button class="cd-iconbtn" type="button" title="Filter">âŸ‚</button>
                        <button class="cd-iconbtn" type="button" title="Download">â‡©</button>
                        <button class="cd-btn" type="button">Explore more</button>
                    </div>
                </div>
                <div class="cd-panel__body">
                    <div class="cd-tablewrap">
                        <table class="cd-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="cd-ta-r">Total</th>
                                    <th class="cd-ta-r">Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RightTableRows.Count == 0)
                                {
                                    <tr><td colspan="3" class="cd-muted">No data in this period.</td></tr>
                                }
                                else
                                {
                                    foreach (var row in Model.RightTableRows)
                                    {
                                        <tr>
                                            <td>@row.Name</td>
                                            <td class="cd-ta-r">@row.ValueText</td>
                                            <td class="cd-ta-r">
                                                <span class="cd-chip @DeltaClass(row.ChangePct)">
                                                    <span class="cd-chip__txt">@FormatPct(row.ChangePct)</span>
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    }

    <div class="cd-modal" data-custom-modal hidden>
        <div class="cd-modal__backdrop" data-close></div>
        <div class="cd-modal__card" role="dialog" aria-modal="true" aria-label="Custom date range">
            <div class="cd-modal__hdr">
                <div class="cd-modal__title">Custom range</div>
                <button class="cd-iconbtn" type="button" data-close aria-label="Close">âœ•</button>
            </div>

            <form class="cd-modal__body" method="get" action="@Url.Action("Index","Metrics")">
                <input type="hidden" name="tab" value="@tab" />
                <input type="hidden" name="range" value="custom" />

                <div class="cd-field">
                    <label class="cd-field__label" for="from">From</label>
                    <input class="cd-field__input" type="date" id="from" name="from" value="@Model.FromDate" />
                </div>

                <div class="cd-field">
                    <label class="cd-field__label" for="to">To</label>
                    <input class="cd-field__input" type="date" id="to" name="to" value="@Model.ToDate" />
                </div>

                <div class="cd-modal__actions">
                    <button class="cd-btnlite" type="button" data-close>Cancel</button>
                    <button class="cd-btnprimary" type="submit">Apply</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/metrics.js" asp-append-version="true"></script>
<script src="~/js/metrics-momentum.js" asp-append-version="true"></script>
